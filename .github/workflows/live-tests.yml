name: Live Tests (Watchdog)

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: "0 2 * * *"
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  live-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Run live integration tests
        id: live_tests
        run: |
          deno test --allow-net --allow-env src/endpoints/live.test.ts
        continue-on-error: true

      - name: Create issue if tests fail
        if: steps.live_tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '⚠️ Live Tests Failed - External API Issue Detected';
            const body = `The live integration tests have failed, indicating a potential issue with one or more external APIs.

            **Run Details:**
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
            - Timestamp: ${new Date().toISOString()}

            **Action Required:**
            Please investigate the failing tests by checking the workflow logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            This could indicate:
            - The external API is down
            - The API response format has changed
            - Network connectivity issues
            - Rate limiting or authentication problems

            **Auto-generated by Live Tests Watchdog**`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'live-tests-failure'
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['live-tests-failure', 'automated', 'bug']
              });
            } else {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Tests failed again on ${new Date().toISOString()}\nSee: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            }
